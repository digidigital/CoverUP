# Restricted to Runtime 48 due to Tcl 9.0 / FreeSimpleGUI incompatibility
# Tcl / Tk were removed from 49 
# FreeSimpleGUI uses the trace variable command which was removed in Tcl 9.0.
# Newest base has issues with package compatibility -> Python 3.13 vs 3.12
# Antialiased font rendering would not be available for Tkinter application.

app-id: de.digidigital.coverup
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
command: coverup

finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # Wayland access
  - --socket=wayland

  # Filesystem access for opening/saving files
  - --filesystem=xdg-documents
  - --filesystem=xdg-download
  - --filesystem=xdg-pictures

  # For file chooser portal
  - --talk-name=org.freedesktop.FileManager1

  # GPU acceleration for rendering
  - --device=dri

modules:
  - name: tcl8.6
    buildsystem: autotools
    subdir: unix
    post-install:
      - chmod 755 ${FLATPAK_DEST}/lib/libtcl8.6.so
    cleanup:
      - /bin
      - /lib/pkgconfig
      - /man
    sources:
      - type: archive
        url: https://prdownloads.sourceforge.net/tcl/tcl8.6.16-src.tar.gz
        sha256: 91cb8fa61771c63c262efb553059b7c7ad6757afa5857af6265e4b0bdc2a14a5

  - name: tk8.6
    buildsystem: autotools
    subdir: unix
    post-install:
      - chmod 755 ${FLATPAK_DEST}/lib/libtk8.6.so
    cleanup:
      - /bin
      - /lib/pkgconfig
      - /man
    sources:
      - type: archive
        url: https://prdownloads.sourceforge.net/tcl/tk8.6.16-src.tar.gz
        sha256: be9f94d3575d4b3099d84bc3c10de8994df2d7aa405208173c709cc404a7e5fe

  - name: python3-tkinter
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} --no-build-isolation .
    sources:
      - type: git
        url: https://github.com/iwalton3/tkinter-standalone
        commit: 88aa05075d90d393a29a484bce676e237d311082

  - name: python3-pillow
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "pillow" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/7f/42/6e0f2c2d5c60f499aa29be14f860dd4539de322cd8fb84ee01553493fb4d/pillow-11.0.0-cp312-cp312-manylinux_2_28_x86_64.whl
        sha256: 00177a63030d612148e659b55ba99527803288cea7c75fb05766ab7981a8c1b7

  - name: python3-freesimplegui
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "FreeSimpleGUI" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/53/c3/4c98171e042203d735a17e638ac1bcfe68ee97686638029214d696d8b9b5/FreeSimpleGUI-5.1.1-py3-none-any.whl
        sha256: d7629d5c94b55264d119bd2a89f52667d863ea7914d808e619aea29922ff842e

  - name: python3-pypdfium2
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "pypdfium2" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/be/d9/a2f1ee03d47fbeb48bcfde47ed7155772739622cfadf7135a84ba6a97824/pypdfium2-4.30.1-py3-none-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: f454032a0bc7681900170f67d8711b3942824531e765f91c2f5ce7937f999794

  - name: python3-defusedxml
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "defusedxml" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/07/6c/aa3f2f849e01cb6a001cd8554a88d4c77c5c1a31c95bdf1cf9301e6d9ef4/defusedxml-0.7.1-py2.py3-none-any.whl
        sha256: a352e7e428770286cc899e2542b6cdaedb2b4953ff269a210103ec58f6198a61

  - name: python3-fonttools
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "fonttools" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c7/4e/ce75a57ff3aebf6fc1f4e9d508b8e5810618a33d900ad6c19eb30b290b97/fonttools-4.61.1-py3-none-any.whl
        sha256: 17d2bf5d541add43822bcf0c43d7d847b160c9bb01d15d5007d84e2217aaa371

  - name: python3-fpdf2
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "fpdf2" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/35/a7/8532d8fffe6d1c388ad4941d678dd0da4d8da80434f2dbf4f35de0fa8029/fpdf2-2.8.5-py3-none-any.whl
        sha256: 2356b94e2a5fcbd1fe53ac5cbb83494e9003308860ab180050255ba50961d913

  - name: python3-appdirs
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "appdirs" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/3b/00/2344469e2084fb287c2e0b57b72910309874c3245463acd6cf5e3db69324/appdirs-1.4.4-py2.py3-none-any.whl
        sha256: a841dacd6b99318a741b166adb07e19ee71a274450e68237b4650ca1055ab128

  - name: coverup
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} ./coverup --no-build-isolation
      - install -Dm644 de.digidigital.coverup.desktop ${FLATPAK_DEST}/share/applications/de.digidigital.coverup.desktop
      - install -Dm644 de.digidigital.coverup.metainfo.xml ${FLATPAK_DEST}/share/metainfo/de.digidigital.coverup.metainfo.xml
      - install -Dm644 de.digidigital.coverup.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/de.digidigital.coverup.svg
      - install -Dm644 coverup/LICENSE ${FLATPAK_DEST}/share/licenses/de.digidigital.coverup/LICENSE
    sources:
      - type: git
        url: https://github.com/digidigital/CoverUP.git
        tag: v0.4.0
        dest: coverup
      - type: file
        path: de.digidigital.coverup.desktop
      - type: file
        path: de.digidigital.coverup.metainfo.xml
      - type: file
        path: de.digidigital.coverup.svg
